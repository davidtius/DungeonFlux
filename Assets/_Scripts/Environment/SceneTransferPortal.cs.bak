using UnityEngine;
using UnityEngine.SceneManagement;

public class SceneTransferPortal : MonoBehaviour
{
    [Header("Destination")]
    public string targetSceneName; 

    [Header("Mode")]
    [Tooltip("Portal di BOSS ROOM (Menuju Sanctuary).")]
    public bool advanceFloor = false; 

    [Tooltip("mengulang dari Lantai 1 (Game Over).")]
    public bool resetRun = false;

    void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            PlayerController pc = other.GetComponent<PlayerController>();
            if (pc != null)
            {
                pc.SaveInventory();
            }

            Debug.Log($"Portal Diinjak! Mode: AdvanceFloor={advanceFloor}, ResetRun={resetRun}, Target={targetSceneName}");
            
            SaveData data = SaveManager.HasSaveFile() ? SaveManager.Load() : new SaveData();

            if (PlayerDataTracker.Instance != null)
            {
                // Update data di file dengan data terbaru dari kantong pemain
                data.totalEctoplasma = PlayerDataTracker.Instance.totalEctoplasma;
            }

            // MODE 1: NAIK LANTAI (Boss -> Sanctuary)
            if (advanceFloor)
            {
                data.currentFloor++; // Naik ke lantai berikutnya (misal 5 jadi 6)
                Debug.Log($"Portal: Stage Clear! Lanjut ke Lantai {data.currentFloor}");
            }
            // MODE 2: RESET (Game Over -> Menu)
            else if (resetRun)
            {
                data.currentFloor = 1; // Ulang dari awal
            }
            // MODE 3: BIASA (Sanctuary -> Dungeon)
            // Tidak melakukan apa-apa pada currentFloor, biar lanjut sesuai save data.

            // Simpan lokasi & data
            data.lastSceneName = targetSceneName;
            SaveManager.Save(data);
            
            // Pindah Scene
                Debug.Log("Loading . . .");
                LevelLoader.LoadLevel(targetSceneName);
        }
    }
}
