using UnityEngine;
using DungeonFlux.AI;

namespace DungeonFlux.Tasks
{
    public class Action_MoveToLastKnownPosition : MonoBehaviour
    {
        [Header("Movement Settings")]
        public float investigationSpeed = 2.5f;

        [Header("Rotation")]
        public float rotationSpeed = 5f;

        private BehaviourTreeRunner btRunner;
        private Vector2 targetPosition;
        private bool isMoving = false;
        private Animator animator;
        private Health myHealth;

        void Start()
        {
            myHealth = GetComponent<Health>();
            btRunner = GetComponent<BehaviourTreeRunner>();
            if (btRunner == null)
            {
                Debug.LogError($"[{gameObject.name}] Action_MoveToLastKnownPosition memerlukan BehaviourTreeRunner");
            }
            animator = GetComponent<Animator>();
        }

        public NodeState ExecuteTask()
        {
            if (btRunner == null) return NodeState.FAILURE;

            // Jika belum bergerak, ambil target dari Runner
            if (!isMoving)
            {
                targetPosition = btRunner.GetLastKnownPlayerPosition();
                isMoving = true;
            }

            float currentSpeed = investigationSpeed;
            if (myHealth != null) currentSpeed *= myHealth.speedMultiplier;

            // Vector2 directionToTarget = (targetPosition - (Vector2)transform.position).normalized;
            // if (directionToTarget != Vector2.zero)
            // {
            //     float targetAngle = Mathf.Atan2(directionToTarget.y, directionToTarget.x) * Mathf.Rad2Deg - 90f; // Sesuaikan -90
            //     Quaternion targetRotation = Quaternion.Euler(0f, 0f, targetAngle);
            //     transform.rotation = Quaternion.Slerp(transform.rotation, targetRotation, rotationSpeed * Time.deltaTime);
            // }

            // Jika sudah sampai di target (atau sangat dekat)
            if (Vector2.Distance(transform.position, targetPosition) < 0.5f)
            {
                isMoving = false; // Berhenti bergerak
                animator.SetFloat("moveX", 0); 
                animator.SetFloat("moveY", 0);
                Debug.Log($"[{gameObject.name}] Sampai di posisi terakhir pemain terlihat.");
                return NodeState.SUCCESS; // investigasi selesai
            }
            else
            {
                // Bergerak menuju target
                Vector2 direction = (targetPosition - (Vector2)transform.position).normalized; 
                transform.position = Vector2.MoveTowards(transform.position, targetPosition, currentSpeed * Time.deltaTime);
                animator.SetFloat("moveX", direction.x); 
                animator.SetFloat("moveY", direction.y);
                return NodeState.RUNNING; // Masih dalam perjalanan
            }
        }

        // Fungsi yang dipanggil BT jika task ini diinterupsi (misal, player terlihat lagi)
        public void OnAbort()
        {
            isMoving = false; // Reset status jika dibatalkan
        }
    }
}